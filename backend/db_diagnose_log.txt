==================================================
数据库诊断开始 - 2025-02-28 07:19:09
==================================================
==================================================
1. 检查系统编码环境
==================================================
Python版本: 3.11.9 (tags/v3.11.9:de54cf5, Apr  2 2024, 10:12:12) [MSC v.1938 64 bit (AMD64)]
系统默认编码: utf-8
标准输出编码: utf-8
文件系统编码: utf-8
区域设置: zh_CN.UTF-8
PYTHONIOENCODING: utf-8
Unicode测试: ✓ ✗ 你好 こんにちは
编码测试通过 ✓

==================================================
2. 测试SQLite连接
==================================================
使用测试数据库URL: sqlite:///./test_diagnose.db
SQLite版本: 3.45.1
数据库连接成功 ✓

==================================================
3. 尝试导入应用数据库配置
==================================================
尝试直接导入app.database...
成功导入app.database: sqlite:///./app.db
应用DATABASE_URL: sqlite:///./app.db
应用Base类已导入 ✓
Base类型: <class 'sqlalchemy.orm.decl_api.DeclarativeMeta'>
Base元数据: MetaData()

==================================================
4. 尝试导入应用模型
==================================================
尝试导入模型...
直接导入失败，尝试动态导入...
找到模型: PackingItem -> 表名: packing_list_items
找到模型: PackingList -> 表名: packing_lists
找到模型: Product -> 表名: products
找到模型: User -> 表名: users
找到 4 个模型
模型 PackingItem -> 表 packing_list_items
模型 PackingList -> 表 packing_lists
模型 Product -> 表 products
模型 User -> 表 users

==================================================
5. 检查模型注册状态
==================================================
Base.metadata中注册的表: ['users', 'products', 'packing_lists', 'packing_list_items', 'box_specs']
所有模型已正确注册到Base.metadata ✓

==================================================
6. 测试表创建功能
==================================================
创建测试模型: test_diagnose_table
测试表创建结果: ['test_diagnose_table']
测试表创建成功 ✓

==================================================
7. 检查应用数据库
==================================================
连接到应用数据库: sqlite:///./app.db
数据库连接成功 ✓
现有表: []
警告: 以下必要表不存在: ['users', 'products', 'packing_lists', 'packing_list_items']

==================================================
8. 尝试手动创建表
==================================================
手动创建表出错: [WinError 32] 另一个程序正在使用此文件，进程无法访问。: 'C:\\Users\\khoo_\\ANY-GO\\backend\\test_diagnose.db'

==================================================
10. 数据库修复工具
==================================================
开始检查数据库问题...
使用数据库URL: sqlite:///./app.db
数据库连接成功 ✓
现有表: []
警告: 未找到users表
开始创建users表...
已创建users表 ✓
已添加管理员用户 ✓

检查模型与数据库表的一致性...
警告: 以下表在模型中定义但在数据库中不存在: ['users', 'products', 'packing_lists', 'packing_list_items', 'box_specs']
开始创建缺失的表...
已创建缺失的表 ✓

检查用户验证逻辑...
未发现用户验证逻辑问题 ✓

==================================================
11. 最终诊断结论
==================================================
发现的问题:
